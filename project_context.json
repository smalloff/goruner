{
  "prompt": "",
  "os": "windows",
  "cwd": "D:\\MYREPA\\goruner",
  "source_code": [
    {
      "path": "app.go",
      "content": "package main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"goruner/internal/config\"\n\t\"goruner/internal/tester\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"strings\"\n\t\"sync\"\n\n\t\"github.com/fsnotify/fsnotify\"\n\twailsRuntime \"github.com/wailsapp/wails/v2/pkg/runtime\"\n)\n\ntype App struct {\n\tctx      context.Context\n\twatcher  *fsnotify.Watcher\n\tmu       sync.Mutex\n\tisPaused bool\n}\n\nfunc NewApp() *App {\n\treturn &App{isPaused: false}\n}\n\nfunc (a *App) startup(ctx context.Context) {\n\ta.ctx = ctx\n\ta.initWatcher()\n}\n\nfunc (a *App) initWatcher() {\n\tw, err := fsnotify.NewWatcher()\n\tif err != nil {\n\t\treturn\n\t}\n\ta.watcher = w\n\n\tgo func() {\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase event, ok := <-a.watcher.Events:\n\t\t\t\tif !ok {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\ta.mu.Lock()\n\t\t\t\tpaused := a.isPaused\n\t\t\t\ta.mu.Unlock()\n\n\t\t\t\tif paused {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\n\t\t\t\t// If a new directory is created, add it to the watcher\n\t\t\t\tcwd, _ := os.Getwd()\n\t\t\t\t\n\t\t\t\tif event.Op&fsnotify.Create != 0 {\n\t\t\t\t\tinfo, err := os.Stat(event.Name)\n\t\t\t\t\tif err == nil && info.IsDir() {\n\t\t\t\t\t\tcfg := config.Load()\n\t\t\t\t\t\tif !cfg.IsExcluded(event.Name, cwd) {\n\t\t\t\t\t\t\t_ = a.watcher.Add(event.Name)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\t\t\tif event.Op&(fsnotify.Write|fsnotify.Create|fsnotify.Rename) != 0 {\n\t\t\t\t\t\t\t\tcfg := config.Load()\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t// Case-insensitive check for .go files\n\t\t\t\t\t\t\t\tif strings.HasSuffix(strings.ToLower(event.Name), \".go\") && cfg.AutoWatch && !cfg.IsExcluded(event.Name, cwd) {\n\t\t\t\t\t\t\t\t\tfmt.Printf(\"[Watcher] Triggering test: %s (Op: %v)\\n\", event.Name, event.Op)\n\t\t\t\t\t\t\t\t\twailsRuntime.EventsEmit(a.ctx, \"trigger_test\", \"File changed: \"+filepath.Base(event.Name))\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\tcase err, ok := <-a.watcher.Errors:\n\t\t\t\t\t\t\tif !ok {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tfmt.Printf(\"[Watcher] Error: %v\\n\", err)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}()\n\n\ta.refreshWatcher()\n}\n\nfunc (a *App) refreshWatcher() {\n\tcfg := config.Load()\n\tcwd, _ := os.Getwd()\n\t\n\t_ = filepath.Walk(cwd, func(path string, info os.FileInfo, err error) error {\n\t\tif err != nil || !info.IsDir() {\n\t\t\treturn nil\n\t\t}\n\t\tif cfg.IsExcluded(path, cwd) {\n\t\t\treturn filepath.SkipDir\n\t\t}\n\t\t_ = a.watcher.Add(path)\n\t\treturn nil\n\t})\n}\n\nfunc (a *App) RunTests() string {\n\tcfg := config.Load()\n\tcwd, _ := os.Getwd()\n\tout, err := tester.RunTests(a.ctx, cwd, cfg.ShowPassed, cfg.Lang)\n\tif err != nil {\n\t\treturn fmt.Sprintf(\"Execution Error: %v\\nOutput: %s\", err, out)\n\t}\n\n\tif cfg.ShowNotifications {\n\t\ta.sendNotification(out, cfg.Lang)\n\t}\n\n\treturn out\n}\n\nfunc (a *App) sendNotification(output string, lang string) {\n\tif runtime.GOOS != \"windows\" {\n\t\treturn\n\t}\n\n\ttitle := \"Go Test Runner\"\n\tmsg := \"\"\n\tisError := strings.Contains(output, \"FAIL\") || strings.Contains(output, \"Error\")\n\n\tif lang == \"ru\" {\n\t\tif isError {\n\t\t\tmsg = \"❌ Тесты провалены! Обнаружены ошибки.\"\n\t\t} else {\n\t\t\tmsg = \"✅ Все тесты пройдены успешно!\"\n\t\t}\n\t} else {\n\t\tif isError {\n\t\t\tmsg = \"❌ Tests failed! Errors detected.\"\n\t\t} else {\n\t\t\tmsg = \"✅ All tests passed successfully!\"\n\t\t}\n\t}\n\n\tnotification := fmt.Sprintf(\"[void][System.Reflection.Assembly]::LoadWithPartialName('System.Windows.Forms'); $obj = New-Object System.Windows.Forms.NotifyIcon; $obj.Icon = [System.Drawing.SystemIcons]::Information; $obj.BalloonTipTitle = '%s'; $obj.BalloonTipText = '%s'; $obj.Visible = $true; $obj.ShowBalloonTip(5000);\", title, msg)\n\t_ = exec.Command(\"powershell\", \"-NoProfile\", \"-Command\", notification).Run()\n}\n\nfunc (a *App) GetDiscoveredTests() []string {\n\tcwd, _ := os.Getwd()\n\tpkgs, _ := tester.DiscoverTests(cwd)\n\treturn pkgs\n}\n\nfunc (a *App) TogglePause() bool {\n\ta.mu.Lock()\n\tdefer a.mu.Unlock()\n\ta.isPaused = !a.isPaused\n\treturn a.isPaused\n}\n\nfunc (a *App) GetConfig() *config.Config {\n\treturn config.Load()\n}\n\nfunc (a *App) SaveConfig(cfg config.Config) {\n\t_ = config.Save(&cfg)\n}"
    }
  ]
}
